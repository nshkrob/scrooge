#!/bin/bash

set -e

./sbt scrooge-generator/assembly

jar=$(ls scrooge-generator/target/scala-2.10/scrooge-generator-assembly-*.jar | tail -1)

gen_root=scrooge-benchmark/src/generated/thrift

gen_services=$gen_root/services

mkdir -p $gen_services

for i in $(seq 1000); do
    echo "service MyService$i { i32 getNumber(1: string someInput) }" > $gen_services/MyService$i.thrift;
done

gen_structs=$gen_root/structs

mkdir -p $gen_structs

for i in $(seq 1000); do
    echo "struct MyStruct$i { 1: string aaaa; 2: i32 bbbb }" > $gen_structs/MyStruct$i.thrift;
done

function bigStruct {
    dest=$1
    set -x
    mkdir -p $(dirname $dest)
    set +x
    echo namespace scala a.b.c.d > $dest
    for i in $(seq 10); do
        echo "struct BigStruct$i {" >> $dest
        for j in $(seq 100); do
            echo "  $j: i64 Field$j" >> $dest
        done
        echo "}" >> $dest
    done
}

gen_big_struct=$gen_root/bigstruct

bigStruct $gen_big_struct/s1.thrift

function compileThrift {
    input=$1
    echo Running on $input

    for lang in scala java experimental-java; do
        lang_opt="--language $lang"
        echo $lang_opt
        dest="$input/$lang"

        time java -jar $jar $input/*.thrift --dest $dest $lang_opt
    done
}
compileThrift $gen_big_struct

compileThrift $gen_services

compileThrift $gen_structs

